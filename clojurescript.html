<!DOCTYPE html>
<html>
<head>
<title>ClojureScript Notes</title>
<!-- 2015-06-27 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="Mark Wallace">
<link rel="Stylesheet" type="text/css" href="assets/css/style.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript">
    function show_org_source(){
       /* document.location.href = rpl(document.location.href,"html","org.html"); */
       var url = document.location.href.split('#')[0];
       document.location.href = url.replace(/.html$/, '.org.html');
    }
</script>
</head>
<body>
<div id="preamble" class="status">
<!--<body onload="prettyPrint()">-->
<nav>
    <a href="index.html">Index</a>
    <a href="about.html">About</a>
    <a href="https://lotabout.github.io">Blog</a>
    <a href="sitemap.html">SiteMap</a>
</nav>
</div>
<div id="content">
<h1 class="title">ClojureScript Notes</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">How do the backend and frontend work together?</a>
<ul>
<li><a href="#sec-1-1">The original case</a></li>
<li><a href="#sec-1-2">New Scenario with Reagent</a></li>
</ul>
</li>
<li><a href="#sec-2">Reagent tips</a></li>
<li><a href="#sec-3">cljs-ajax notes</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">How do the backend and frontend work together?</h2>
<div class="outline-text-2" id="text-1">
<p>
While I was studying reagent, a ClojureScript interface to React.js, I am
confused about how the back-end and front-end worked together.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">The original case</h3>
<div class="outline-text-3" id="text-1-1">
<p>
For example, the backend had a data table with several columns, how do the
backend pass the data to the frontend? In normal HTML way, we can have a route
that fetch the whole page, and the page render(backend) will read the saved data
and use it to render a page that contains data and send it to the client(front-end).
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #f0dfaf; font-weight: bold;">def</span> <span style="color: #dfaf8f;">data</span>
  [{<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"CS001"</span> <span style="color: #bfebbf;">:password</span> <span style="color: #cc9393;">"cs001"</span>}
   {<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"CS002"</span> <span style="color: #bfebbf;">:password</span> <span style="color: #cc9393;">"cs002"</span>}
   {<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"CS003"</span> <span style="color: #bfebbf;">:password</span> <span style="color: #cc9393;">"cs003"</span>}])

(<span style="color: #f0dfaf; font-weight: bold;">defn</span> <span style="color: #8cd0d3;">show-table</span> [data]
  [<span style="color: #bfebbf;">:table</span>
   [<span style="color: #bfebbf;">:tr</span>
    [<span style="color: #bfebbf;">:th</span> <span style="color: #cc9393;">"Username"</span>]
    [<span style="color: #bfebbf;">:th</span> <span style="color: #cc9393;">"Password"</span>]]
   (<span style="color: #f0dfaf; font-weight: bold;">for</span> [row data]
     [<span style="color: #bfebbf;">:tr</span>
      [<span style="color: #bfebbf;">:td</span> (<span style="color: #bfebbf;">:username</span> row)]
      [<span style="color: #bfebbf;">:td</span> (<span style="color: #bfebbf;">:password</span> row)]])])

(<span style="color: #f0dfaf; font-weight: bold;">defn</span> <span style="color: #8cd0d3;">test-page</span> []
  (<span style="color: #8cd0d3;">hiccup.core</span>/html (show-table data)))

(<span style="color: #f0dfaf; font-weight: bold;">defroutes</span> <span style="color: #8cd0d3;">test-routes</span>
  (<span style="color: #bfebbf;">GET</span> <span style="color: #cc9393;">"/test"</span> [] (test-page)))
</pre>
</div>

<p>
Here when we request the page "/test", the server will render the page according
to the <code>data</code> variable here. Imaging that we replace it with a retrieval call
to database so that the data are transfered to the front-end.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">New Scenario with Reagent</h3>
<div class="outline-text-3" id="text-1-2">
<p>
When use Reagent or React.js, the recommended behavior is to let React take over
all the render tasks. That means instead of rendering the page in the backend
like what we did with <code>hiccup</code> in the above example, we apply the new scenario:
</p>

<ol class="org-ol">
<li>write all the components in the frontend code.
</li>
<li>backend provide interface for fetch data(mainly ajax)
</li>
<li>react.js retrieve the data via ajax.
</li>
</ol>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #f0dfaf; font-weight: bold;">def</span> <span style="color: #dfaf8f;">data</span>
    [{<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"CS001"</span> <span style="color: #bfebbf;">:password</span> <span style="color: #cc9393;">"cs001"</span>}
     {<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"CS002"</span> <span style="color: #bfebbf;">:password</span> <span style="color: #cc9393;">"cs002"</span>}
     {<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"CS003"</span> <span style="color: #bfebbf;">:password</span> <span style="color: #cc9393;">"cs003"</span>}
     {<span style="color: #bfebbf;">:username</span> <span style="color: #cc9393;">"&#20013;&#25991;"</span> <span style="color: #bfebbf;">:password</span> 123}])

(<span style="color: #f0dfaf; font-weight: bold;">defroutes</span> <span style="color: #8cd0d3;">home-routes</span>
  (<span style="color: #bfebbf;">GET</span> <span style="color: #cc9393;">"/test"</span> [] (response {<span style="color: #bfebbf;">:data</span> data})))
</pre>
</div>

<p>
Note that we use "luminus" here, and if the body of a response is a map, then
the map will be transformed into json type. So that the client side's ajax
request will get a json response.
</p>

<p>
Now we compose the client side code:
</p>
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #f0dfaf; font-weight: bold;">defn</span> <span style="color: #8cd0d3;">datatable</span> []
  (<span style="color: #f0dfaf; font-weight: bold;">let</span> [user-data (atom <span style="color: #bfebbf;">nil</span>)]
    (<span style="color: #bfebbf;">GET</span> <span style="color: #cc9393;">"/test"</span> {<span style="color: #bfebbf;">:handler</span> #(reset! user-data (<span style="color: #dfaf8f;">%</span> <span style="color: #cc9393;">"data"</span>))})
    (<span style="color: #f0dfaf; font-weight: bold;">fn</span> []
      (<span style="color: #8cd0d3;">.log</span> <span style="color: #8cd0d3;">js</span>/console (str <span style="color: #cc9393;">"datatable: "</span> @user-data))
      [<span style="color: #bfebbf;">:table</span>
       [<span style="color: #bfebbf;">:tr</span>
        [<span style="color: #bfebbf;">:th</span> <span style="color: #cc9393;">"Username"</span>]
        [<span style="color: #bfebbf;">:th</span> <span style="color: #cc9393;">"Password"</span>]]
       (<span style="color: #f0dfaf; font-weight: bold;">for</span> [row @user-data]
         ^{<span style="color: #bfebbf;">:key</span> (row <span style="color: #cc9393;">"username"</span>)}
         [<span style="color: #bfebbf;">:tr</span>
          [<span style="color: #bfebbf;">:td</span> (row <span style="color: #cc9393;">"username"</span>)]
          [<span style="color: #bfebbf;">:td</span> (row <span style="color: #cc9393;">"password"</span>)]])])))

(<span style="color: #f0dfaf; font-weight: bold;">defn</span> <span style="color: #8cd0d3;">mount-components</span> []
  (<span style="color: #8cd0d3;">reagent</span>/render-component [datatable] (<span style="color: #8cd0d3;">.getElementById</span> <span style="color: #8cd0d3;">js</span>/document <span style="color: #cc9393;">"playground"</span>)))
</pre>
</div>

<p>
In this way, it seems that we no longer uses the MVC pattern. The Model part can
be all backend's work, and View part is now taken over by client side. And the
Controller part can be implemented either by server side or client side.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Reagent tips</h2>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">cljs-ajax notes</h2>
<div class="outline-text-2" id="text-3">
<p>
An example of receiving <code>edn</code> response. Note that <code>:format</code> is used to specify
the format to send to the server, and the <code>:response-format</code> is used to tell
<code>cljs-ajax</code> about the response format from the server.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #f0dfaf; font-weight: bold;">let</span> [state (atom <span style="color: #bfebbf;">nil</span>)]
  (<span style="color: #bfebbf;">GET</span> <span style="color: #cc9393;">"/comments"</span> {<span style="color: #bfebbf;">:response-format</span> <span style="color: #bfebbf;">:edn</span>
                    <span style="color: #bfebbf;">:handler</span> #(reset! state <span style="color: #dfaf8f;">%</span>)}))

(<span style="color: #bfebbf;">POST</span> url {<span style="color: #bfebbf;">:headers</span> {<span style="color: #cc9393;">"x-csrf-token"</span> (<span style="color: #8cd0d3;">.-value</span> (<span style="color: #8cd0d3;">.getElementById</span> <span style="color: #8cd0d3;">js</span>/document <span style="color: #cc9393;">"token"</span>))}
                        <span style="color: #bfebbf;">:format</span> <span style="color: #bfebbf;">:edn</span>
                        <span style="color: #bfebbf;">:params</span> {<span style="color: #bfebbf;">:comment</span> comment}
                        <span style="color: #bfebbf;">:response-format</span> <span style="color: #bfebbf;">:edn</span>
                        <span style="color: #bfebbf;">:handler</span> #(reset! state <span style="color: #dfaf8f;">%</span>)})
</pre>
</div>

<p>
Note that Luminus use CSRF by default, so we need to specify CSRF token in the
header, check <a href="http://www.luminusweb.net/docs/security.md">Luminus Security</a>
for more details.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="#" class="back-to-top">Back to Top</a>

<!-- <hr class="comment"> -->
<!-- <div id="show_source"> -->
<!--   <input type="button" value="Show Org source" onClick='show_org_source()'> -->
<!-- </div> -->

</script>
<hr class="comment">
<section class="comment">
<!-- An element a visitor can click if they <3 comments! -->
<button class="btn show-comments">Load Disqus comments</button>
<div id="disqus_thread"></div>
 
<!-- The empty element required for Disqus to loads comments into -->
<!--<div id="disqus_thread"></div>-->
    <!--<script type="text/javascript">-->
        <!--/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */-->
        <!--var disqus_shortname = 'lotaboutvimwiki'; // required: replace example with your forum shortname-->

        <!--/* * * DON'T EDIT BELOW THIS LINE * * */-->
        <!--(function() {-->
            <!--var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;-->
            <!--dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';-->
            <!--(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);-->
        <!--})();-->
    <!--</script>-->
    <!--<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>-->
</section>

<footer>
    |采用<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">CC BY-NC-SA 3.0</a>授权|由<a href="http://orgmode.org">Org Mode</a>自动生成<input type="button" value="Show Org source" onClick='show_org_source()'>|部署在<a href="https://github.com/lotabout/orgwiki">Github Pages</a>|
</footer>

    <script src="assets/js/jquery-1.7.1.min.js"></script>
    <script>
$(document).ready(function(){
	var offset = 100;
	var duration = 110;

        $(window).resize(function () {
            var toc= $('#table-of-contents')
            if ($(window).width() <= 800) {
                toc.css('position', 'static')
	        return
            }
            });
        $(window).scroll(
            function () {
            console.log("scroll called.")
            var toc= $('#table-of-contents')
            if ($(window).width() <= 800) {
            toc.css('position', 'static')
            return
            }

            if ($(this).scrollTop() > duration) {
            toc.css('left', toc.position().left + 'px')
            toc.css('position', 'fixed')
            $('.back-to-top').fadeIn(duration);
            } else {
            toc.css('left', '0px')
            toc.css('top', '0px')
            toc.css('position', 'relative')
            $('.back-to-top').fadeOut(duration);
            }
            });
        $('.back-to-top').click(
            function(event) {
            event.preventDefault;
            $('html, body').animate({scrollTop: 0}, duration);
            return false;
            });

        $('.show-comments').on('click', function(){
                               var disqus_shortname = 'lotaboutorgwiki'; // Replace this value with *your* username.

                               // ajax request to load the disqus javascript
                               $.ajax({
type: "GET",
url: "http://" + disqus_shortname + ".disqus.com/embed.js",
dataType: "script",
cache: true
});
                               // hide the button once comments load
                               $(this).fadeOut();
                               });
});
    </script>
</div>
</body>
</html>
