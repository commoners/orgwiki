<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.47 in css mode. -->
<html>
  <head>
    <title>javascript.org</title>
    <style type="text/css">
    <!--
      body {
        color: #dcdccc;
        background-color: #3f3f3f;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .hl-line {
        /* hl-line */
        background-color: #404040;
      }
      .org-block {
        /* org-block */
        color: #b3b3b3;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #7f9f7f;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #7f9f7f;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #dfaf8f;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #8fb28f;
      }
      .org-level-3 {
        /* org-level-3 */
        color: #7cb8bb;
      }
      .org-link {
        /* org-link */
        color: #d0bf8f;
        text-decoration: underline;
      }
      .org-list-dt {
        /* org-list-dt */
        font-weight: bold;
      }
      .org-target {
        /* org-target */
        text-decoration: underline;
      }
      .org-verbatim {
        /* org-verbatim */
        color: #b3b3b3;
      }
      .underline {
        /* underline */
        text-decoration: underline;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-document-info-keyword"><span class="hl-line">#+title:</span></span><span class="hl-line"> </span><span class="org-document-title"><span class="hl-line">JavaScript Notes
</span></span>
<span class="org-level-1">* JS Box metrics</span>
<span class="org-target">&lt;&lt;sec:js-box-metrics&gt;&gt;</span>

There are several concepts of metrics used in javascript.

<span class="org-level-2">** CSS width/height</span>

Without <span class="org-verbatim">=box-sizing: border-box=</span> being set, it is the size of the
<span class="underline">_content area_</span>, which lies inside the padding. CSS properties can be
set using <span class="org-verbatim">=element.style=</span> property and retrieved using
<span class="org-verbatim">=getComputedStyle()/currentStyle=</span>.

<span class="org-level-2">** clientWidth/Height</span>

Size of the <span class="org-verbatim">=client area=</span>: content area with padding, but without scrollbars.

<span class="org-block-begin-line">#+begin_example
</span><span class="org-block">  clientWidth = CSS-width + paddings - scrollbar-width;
  clientHeight = CSS-height + paddings - scrollbar-height;
</span><span class="org-block-end-line">#+end_example
</span>
NOTE: the scrollbars will first occupy the padding area, and if the
padding area is not large enough, it will further occupy the content
area, meanwhile the CSS width/height stays unchanged. Thus as in the
following image where <span class="org-verbatim">=padding &gt; scrollbar-width=</span>:

<span class="org-link"><a href="http://javascript.info/files/tutorial/browser/dom/metric2.png">[[</a><a href="http://javascript.info/files/tutorial/browser/dom/metric2.png">http://javascript.info/files/tutorial/browser/dom/metric2.png</a><a href="http://javascript.info/files/tutorial/browser/dom/metric2.png">]]</a></span>

The size can be calculated:
<span class="org-block-begin-line">#+begin_example
</span><span class="org-block">  clientWidth = 300(width) + 40(paddings) - 16(scrollbar) = 324
  clientHeight = 200(height) + 40(paddings) = 240
</span><span class="org-block-end-line">#+end_example
</span>
However, if the <span class="org-verbatim">=padding &lt; scrollbar-width=</span>:

<span class="org-link"><a href="http://javascript.info/files/tutorial/browser/dom/metricClientWidth.png">[[</a><a href="http://javascript.info/files/tutorial/browser/dom/metricClientWidth.png">http://javascript.info/files/tutorial/browser/dom/metricClientWidth.png</a><a href="http://javascript.info/files/tutorial/browser/dom/metricClientWidth.png">]]</a></span>

The <span class="underline">_CSS width_</span> stays unchanged(300px), while the client width:

<span class="org-block-begin-line">#+begin_example
</span><span class="org-block">  clientWidth = 300(width) + 0(paddings) - 16(scrollbar) = 284
</span><span class="org-block-end-line">#+end_example
</span>
Thus the <span class="org-verbatim">=clientWidth/clientHeight=</span> reflect the real size of the content.

<span class="org-level-2">** scrollWidth/Height</span>
Content area width and height <span class="underline">_including_</span> the scrolled out part. That
means they are the same as clientWidth/Height, but includes full
scrollable area.

<span class="org-level-2">** scrollTop/scrollLeft</span>
The size of scrolled out part: vertical and horizontal. The value is
always in pixels.

NOTE that you can set values to this property, the browser will scroll
the document accordingly.

<span class="org-level-2">** offsetWidth/Height</span>
Outer box width/height, full size with borders, but without margins.

<span class="org-level-2">** clientTop/Left</span>
The indent of <span class="underline">_client area_</span> from box outer corner.

<span class="org-link"><a href="http://javascript.info/files/tutorial/browser/dom/metric3.png">[[</a><a href="http://javascript.info/files/tutorial/browser/dom/metric3.png">http://javascript.info/files/tutorial/browser/dom/metric3.png</a><a href="http://javascript.info/files/tutorial/browser/dom/metric3.png">]]</a></span>

Normally, the value is:
<span class="org-block-begin-line">#+begin_example
</span><span class="org-block">clientTop = border-top-width
clientLeft = border-left-width
</span><span class="org-block-end-line">#+end_example
</span>
However, in case of a <span class="underline">_right-to-left_</span> document, where the scrollbar
appears on the top and left, the value is:
<span class="org-block-begin-line">#+begin_example
</span><span class="org-block">clientTop = border-top-width + scrollbar-width
clientLeft = border-left-width + scrollbar-width
</span><span class="org-block-end-line">#+end_example
</span>
<span class="org-level-2">** offsetParent, offsetLeft/Top</span>
Properties <span class="org-verbatim">=offsetLeft=</span> and <span class="org-verbatim">=offsetTop=</span> reflects a relative shift of
an element from its <span class="org-verbatim">=offsetParent=</span>.

The <span class="org-verbatim">=offsetParent=</span> is the closest(nearest in the containment
hierarchy) <span class="bold">*positioned*</span> containing element. If the element is
non-positioned, but the ancestor is a table cell(<span class="org-verbatim">=td=</span>, <span class="org-verbatim">=th=</span> or
<span class="org-verbatim">=table=</span>) or root element (<span class="org-verbatim">=html=</span> in standards compliant mode; <span class="org-verbatim">=body=</span>
in quirks rendering mode) is the <span class="org-verbatim">=offsetParent=</span>. See
<span class="org-link"><a href="http://dev.w3.org/csswg/cssom-view/#dom-htmlelement-offsetparent">[[http://dev.w3.org/csswg/cssom-view/#dom-htmlelement-offsetparent][</a><a href="http://dev.w3.org/csswg/cssom-view/#dom-htmlelement-offsetparent">DOM
HTML Element -- offsetparent</a><a href="http://dev.w3.org/csswg/cssom-view/#dom-htmlelement-offsetparent">]]</a></span> for specification.

<span class="org-link"><a href="http://javascript.info/files/tutorial/browser/dom/metricOffset.png">[[</a><a href="http://javascript.info/files/tutorial/browser/dom/metricOffset.png">http://javascript.info/files/tutorial/browser/dom/metricOffset.png</a><a href="http://javascript.info/files/tutorial/browser/dom/metricOffset.png">]]</a></span>

<span class="org-level-2">** Summary</span>
1. The <span class="underline">_CSS width/height_</span> is the width of the content area, and will
   stick to the value it is.
2. The <span class="org-verbatim">=Client Area=</span> is the content area plus padding, but do not include
   the scrollbar.
3. The <span class="org-verbatim">=Offset Area=</span> is the whole content of an element except the margin.
4. All the width/height and left/top properties are calculated
   according to what they are(client/offset area).

<span class="org-link"><a href="http://javascript.info/files/tutorial/browser/dom/metricSummary.png">[[</a><a href="http://javascript.info/files/tutorial/browser/dom/metricSummary.png">http://javascript.info/files/tutorial/browser/dom/metricSummary.png</a><a href="http://javascript.info/files/tutorial/browser/dom/metricSummary.png">]]</a></span>



<span class="org-level-2">** References</span>
<span class="org-link"><a href="http://javascript.info/tutorial/metrics">[[http://javascript.info/tutorial/metrics][</a><a href="http://javascript.info/tutorial/metrics">JS metrics</a><a href="http://javascript.info/tutorial/metrics">]]</a></span>

<span class="org-level-1">* JS Position/Offset</span>

The <span class="org-link"><a href="sec:js-box-metrics">[[sec:js-box-metrics][</a><a href="sec:js-box-metrics">previous section</a><a href="sec:js-box-metrics">]]</a></span> introduced the box model
of javascript. However, there are still two important requirement we
have: get the position of current element.

Two concept will be involed here: document and viewport.

<span class="org-link"><a href="https://developer.mozilla.org/en/docs/Web/API/Document">[[https://developer.mozilla.org/en/docs/Web/API/Document][</a><a href="https://developer.mozilla.org/en/docs/Web/API/Document">Document</a><a href="https://developer.mozilla.org/en/docs/Web/API/Document">]]</a></span>
serves as an entry point into the web page's content(The DOM
tree). You can treat it as the <span class="org-verbatim">=&lt;html&gt;=</span> object in HTML source
code. And JS provide a variable <span class="org-verbatim">=document=</span> for it.

<span class="org-link"><a href="https://developer.mozilla.org/en-US/docs/Glossary/Viewport">[[https://developer.mozilla.org/en-US/docs/Glossary/Viewport][</a><a href="https://developer.mozilla.org/en-US/docs/Glossary/Viewport">Viewport</a><a href="https://developer.mozilla.org/en-US/docs/Glossary/Viewport">]]</a></span>
represents a polygonal(normally rectangular) area in computer graphics
currently being viewed. So we can treat it as the browser that
displays contents. 

I actually cannot distinguish viewport from
<span class="org-link"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window">[[https://developer.mozilla.org/en-US/docs/Web/API/Window][</a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window">window</a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window">]]</a></span>,
it seems that viewport is an abstract concept that refer to any
view-able area, while window refers to the actual "physical" object.

Because the window size can scroll, so the position of an element
could be relative to either document or viewport.

As for those relative to the <span class="bold">*viewport*</span>, JS provide us a handy function:
<span class="org-link"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect">[[https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect][</a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect">getBoundingClientRect()</a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect">]]</a></span>
that will return the size of an element and its position relative to viewport.

As for those relative to the <span class="bold">*document*</span>, JS do not have direct answer,
however the JQuery function <span class="org-link"><a href="http://api.jquery.com/offset/">[[http://api.jquery.com/offset/][</a><a href="http://api.jquery.com/offset/">.offset</a><a href="http://api.jquery.com/offset/">]]</a></span>
is an alternate to that. Of course you can implement it in plain JS as
well, You can check the JQuery implementation
<span class="org-link"><a href="http://james.padolsey.com/jquery/#v%3D1.11.2&amp;fn%3DjQuery.fn.offset">[[http://james.padolsey.com/jquery/#v%3D1.11.2&amp;fn%3DjQuery.fn.offset][</a><a href="http://james.padolsey.com/jquery/#v%3D1.11.2&amp;fn%3DjQuery.fn.offset">here</a><a href="http://james.padolsey.com/jquery/#v%3D1.11.2&amp;fn%3DjQuery.fn.offset">]]</a></span>.

<span class="org-level-1">* Event Position</span>
- <span class="org-list-dt">clientX/clientY ::</span> the coordinate of the mouse pointer relative
     to the current window(viewport), when the event was triggered.
- <span class="org-list-dt">screenX/screenY ::</span> the coordinate of the mouse pointer, relative to
     the screen, when the event was triggered.
- <span class="org-list-dt">pageX/pageY ::</span> the coordinate of the event relative to the whole
                 document. This is non-standard.
- <span class="org-list-dt">layerX/layerY ::</span> the coordinate of the event relative to the current
                   layer. Non-standard.

<span class="org-link"><a href="http://web.jobbole.com/82419/">[[http://web.jobbole.com/82419/][</a><a href="http://web.jobbole.com/82419/">About JS event</a><a href="http://web.jobbole.com/82419/">]]</a></span>

<span class="org-level-1">* Prototype</span>
Modifying the prototype of a javascript class(i.e. a function) will
affect all instances using this object. It is like editing the class
itself in Java and all instances of this class will be affected.

<span class="org-link"><a href="http://www.w3schools.com/js/js_object_prototypes.asp">[[http://www.w3schools.com/js/js_object_prototypes.asp][</a><a href="http://www.w3schools.com/js/js_object_prototypes.asp">prototype</a><a href="http://www.w3schools.com/js/js_object_prototypes.asp">]]</a></span> is
the only way of doing this.

<span class="org-level-1">* This</span>
NOTE: this section is maily taken from <span class="org-link"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">[[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this][</a><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">MDN</a><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">]]</a></span>

Normally,
<span class="org-link"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">[[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this][</a><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">this</a><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">]]</a></span>
is determined by how a function is called. It cannot be set by
assignment during execution.

<span class="org-level-2">** Global context</span>
In global execution contex(outside of any function) <span class="org-verbatim">=this=</span> refers to
the global object, whether in scrit mode or not.

<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  console.log(this.document === document); // true
  
  // In web browsers, the window object is also the global object:
  console.log(this === window); // true
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** Function context</span>
Inside a function, the value of <span class="org-verbatim">=this=</span> depends on how the function is
called.

<span class="org-level-3">*** Simple call</span>
<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  function f1(){
    return this;
  }
  
  f1() === window; // global object
</span><span class="org-block-end-line">#+end_src
</span>
In this case, the value of <span class="org-verbatim">=this=</span> is not set by the call. Since the
code is not in <span class="org-verbatim">=strict=</span> mode, the value of <span class="org-verbatim">=this=</span> must always be an
object so it defaults to the global object.

<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  function f2(){
    "use strict"; // see strict mode
    return this;
  }
  
  f2() === undefined;
</span><span class="org-block-end-line">#+end_src
</span>
In <span class="org-verbatim">=strict=</span> mod,e the value of <span class="org-verbatim">=this=</span> remains at whatever it is set
when entering the execution context.

<span class="org-level-3">*** As an object method</span>
When a function is called as a method of an object, its <span class="org-verbatim">=this=</span> is set
to the object the method is called on.

<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  var o = {
      prop: 37,
      f: function() {
          return this.prop;
      }
  };
  
  console.log(o.f()); // logs 37
</span><span class="org-block-end-line">#+end_src
</span>
This behavior is not at all affected by how or where the function was defined.

<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  var o = {prop: 37};
  
  function independent() {
    return this.prop;
  }
  
  o.f = independent;
  
  console.log(o.f()); // logs 37
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-3">*** As a constructor</span>
when a function is used as a constructor(with the <span class="org-verbatim">=new=</span> keyword), its
<span class="org-verbatim">=this=</span> is bound to the new object being constructed.

<span class="org-level-3">*** call and apply</span>
By utilizing <span class="org-verbatim">=call=</span> and <span class="org-verbatim">=apply=</span>, we are able to specify <span class="org-verbatim">=this=</span> in a
function to anything we want:
<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  function add(c, d){
    return this.a + this.b + c + d;
  }
  
  var o = {a:1, b:3};
  
  // The first parameter is the object to use as
  // 'this', subsequent parameters are passed as 
  // arguments in the function call
  add.call(o, 5, 7); // 1 + 3 + 5 + 7 = 16
  
  // The first parameter is the object to use as
  // 'this', the second is an array whose
  // members are used as the arguments in the function call
  add.apply(o, [10, 20]); // 1 + 3 + 10 + 20 = 34
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** As a DOM event handler</span>
When a function is used as an event handler, its <span class="org-verbatim">=this=</span> is set to the
element the event fired from.

<span class="org-level-2">** As an in-line event handler</span>
Its <span class="org-verbatim">=this=</span> is set to the DOM element on which the listener is placed.

<span class="org-level-2">** Read More</span>
- <span class="org-link"><a href="http://web.jobbole.com/54267/">[[http://web.jobbole.com/54267/][</a><a href="http://web.jobbole.com/54267/">&#35299;&#23494; JavaScript &#20013;&#30340; this</a><a href="http://web.jobbole.com/54267/">]]</a></span>

<span class="org-level-1">* Javascript and OOP</span>

Actually ECMAScript 2015(ES6) introduced some new keywords to support
OOP in javascript. But we can actually simulate the OOP in older
versions. Here are something to note when implement it.

<span class="bold">*Two things*</span> we need to care about are:
1. How to inherit properties and methods from the super class?
2. How to properly set the initial values of inherited properties?

<span class="org-level-2">** The inheritance chain</span>
The first is called to
<span class="org-link"><a href="http://stackoverflow.com/questions/4152931/javascript-inheritance-call-super-constructor-or-use-prototype-chain">[[http://stackoverflow.com/questions/4152931/javascript-inheritance-call-super-constructor-or-use-prototype-chain][</a><a href="http://stackoverflow.com/questions/4152931/javascript-inheritance-call-super-constructor-or-use-prototype-chain">construct
a prototype chain</a><a href="http://stackoverflow.com/questions/4152931/javascript-inheritance-call-super-constructor-or-use-prototype-chain">]]</a></span>. Which is a function like this:

<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  function extend(base, sub) {
    // Avoid instantiating the base class just to setup inheritance
    // See <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create</a>
    // for a polyfill
    // Also, do a recursive merge of two prototypes, so we don't overwrite 
    // the existing prototype, but still maintain the inheritance chain
    // Thanks to @ccnokes
    var origProto = sub.prototype;
    sub.prototype = Object.create(base.prototype);
    for (var key in origProto)  {
       sub.prototype[key] = origProto[key];
    }
    // Remember the constructor property was set wrong, let's fix it
    sub.prototype.constructor = sub;
    // In ECMAScript5+ (all modern browsers), you can make the constructor property
    // non-enumerable if you define it like this instead
    Object.defineProperty(sub.prototype, 'constructor', { 
      enumerable: false, 
      value: sub 
    });
  }
</span><span class="org-block-end-line">#+end_src
</span>
With the help of the lookup strategy of Javascript's prototype, now
we inherited parent's properties and methods(called prototype).

<span class="org-level-2">** The constructor hierarchy</span>
In traditional OOP language like java, we will initialize the
properties in its constructor, and when it is inherited by a
subclass, we should call its constructor in the subclass to get the
things right.

<span class="org-block-begin-line">#+begin_src java
</span><span class="org-block">public class Shape {
    private String shape;

    Shape(String shape) {
        this.shape = shape;
    }

    String getShape() {
        return shape;
    }
}
public class Rect extends Shape {
    private int width;
    private int height;
    Rect() {
        super("rect");
        width = 0;
        height = 0;
    }

    public static void main(String[] args) {
        Rect rect = new Rect();
        System.out.println(rect.getShape());
    }
}
</span><span class="org-block-end-line">#+end_src
</span>
Note the call to <span class="org-verbatim">=super=</span> which in this case refer to constructor <span class="org-verbatim">=Shape(String)=</span>.

Although we've constructed the inheritance chain, the properties that
are set via the constructor can not be conveniently set in the sub
class. Here is a way to directly call the constructor of the super
class:

<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  function Shape(shape) {
      this.shape = shape;
  }
  
  Shape.prototype.getShape = function () {
      return this.shape;
  }
  
  function Rect() {
      // should call the super class
      Shape.call(this, "rect")
  }
  
  extend(Shape, Rect);
  
  var rect = new Rect();
  console.log(rect.getShape());
</span><span class="org-block-end-line">#+end_src
</span>
The problem is with the <span class="org-verbatim">=extend=</span> utility, we actually haven't decide
which super class we are going to extend, that means we don't know
the name of <span class="org-verbatim">=Shape=</span> when we write <span class="org-verbatim">=Rect()=</span>. And under ECMAScript
2015, we don't have the <span class="org-verbatim">=super=</span> keyword to refer to the constructor.

So we need to save the super class's constructor. Below is the
modified version of <span class="org-verbatim">=extend=</span>:
<span class="org-block-begin-line">#+begin_src java
</span><span class="org-block">  function extend(base, sub) {
      var origProto = sub.prototype;
      sub.prototype = Object.create(base.prototype);
      for (var key in origProto)  {
          sub.prototype[key] = origProto[key];
      }
  
      // save the super class's constructor.
      sub.prototype.superConstructor = base.prototype.constructor
  
      sub.prototype.constructor = sub;
      Object.defineProperty(sub.prototype, 'constructor', { 
          enumerable: false, 
          value: sub 
      });
  }
</span><span class="org-block-end-line">#+end_src
</span>
Now it's time to replace the call to <span class="org-verbatim">=Shape=</span>:
<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">  function Rect() {
      this.superConstructor.call(this, "rect")
  }
</span><span class="org-block-end-line">#+end_src
</span>
And we get the same result.

In this way, we get the basic OOP out of javascript, however, there
is no default call to super class's default constructor. So we should
manually call it every time. Please think about what you can do to
enhance it.
</pre>
  </body>
</html>
